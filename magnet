#!/usr/bin/env bash
set -u

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Magnet Package Management Wrapper  #
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

LOGFILE="/var/log/magnet.log"

log() {
    echo "[MAGNET] $1"
    echo "[MAGNET] $1" >> "$LOGFILE" 2>/dev/null || true
}

if [[ -z "${2:-}" && "$1" != "update" ]]; then
    echo "Error: Missing package name."
    exit 1
fi

#%%%%%%%%%%%%%%%%%%%%% Config %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

DEBIAN_BOX="magnet-debian"
FEDORA_BOX="magnet-fedora"

#%%%%%%%%%%%%%%%%%%%%% Helpers %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

command_exists() {
    command -v "$1" >/dev/null 2>&1
}

pacman_has() {
    pacman -Si "$1" &>/dev/null
}

aur_has() {
    sudo -u "$SUDO_USER" yay -Si "$1" &>/dev/null
}

apt_has() {
    sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- apt-cache search "$1" &>/dev/null
}

dnf_has() {
    sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- dnf search "$1" &>/dev/null
}

#%%%%%%%%%%%%%%%%%%%%%% Search %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

search_pkg() {
    PKG="$1"
    FOUND=0

    log "Searching for $PKG..."

    if pacman_has "$PKG"; then
        echo "✔ Found in pacman (Arch)"
        FOUND=1
    fi

    if command_exists yay && aur_has "$PKG"; then
        echo "✔ Found in AUR"
        FOUND=1
    fi

    if apt_has "$PKG"; then
        echo "✔ Found in Debian container"
        FOUND=1
    fi

    if dnf_has "$PKG"; then
        echo "✔ Found in Fedora container"
        FOUND=1
    fi

    if [[ $FOUND -eq 0 ]]; then
        echo "✘ Package not found anywhere."
        exit 1
    fi
}

#%%%%%%%%%%%%%%%%%%%%%% Install %%%%%%%%%%%%%%%%%%%%%%%%%%%%

install_pkg() {
    local PKG="$1"
    local FORCED_SOURCE="$2"

    log "Searching for $PKG..."

    # If user forced a source
    if [[ -n "$FORCED_SOURCE" ]]; then
        case "$FORCED_SOURCE" in
            pacman)
                pacman_has "$PKG" || { echo "Not found in pacman"; exit 1; }
                sudo pacman -S --needed "$PKG"
                ;;
            aur)
                aur_has "$PKG" || { echo "Not found in AUR"; exit 1; }
                sudo -u "$SUDO_USER" yay -S "$PKG"
                ;;
            debian)
                apt_has "$PKG" || { echo "Not found in Debian container"; exit 1; }
                sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- sudo apt install -y "$PKG"
                ;;
            fedora)
                dnf_has "$PKG" || { echo "Not found in Fedora container"; exit 1; }
                sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- sudo dnf install -y "$PKG"
                ;;
            *)
                echo "Invalid source: $FORCED_SOURCE"
                exit 1
                ;;
        esac
        return
    fi

    # Default order logic
    if pacman_has "$PKG"; then
        sudo pacman -S --needed "$PKG"
        return
    fi

    if command_exists yay && aur_has "$PKG"; then
        sudo -u "$SUDO_USER" yay -S "$PKG"
        return
    fi

    if apt_has "$PKG"; then
        sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- sudo apt install -y "$PKG"
        return
    fi

    if dnf_has "$PKG"; then
        sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- sudo dnf install -y "$PKG"
        return
    fi

    echo "Package '$PKG' not found anywhere."
    exit 1
}

#%%%%%%%%%%%%%%%%%%%%%% Remove %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

remove_pkg() {
    PKG="$1"
    FOUND=0

    log "Searching for $PKG..."

    if pacman -Qi "$PKG" &>/dev/null; then
        log "Removing via pacman..."
        sudo pacman -Rns "$PKG"
        FOUND=1
    fi

    if command_exists yay && yay -Qi "$PKG" &>/dev/null; then
        log "Removing via AUR..."
        sudo -u "$SUDO_USER" yay -Rns "$PKG"
        FOUND=1
    fi

    if distrobox enter "$DEBIAN_BOX" -- dpkg -s "$PKG" &>/dev/null; then
        log "Removing via Debian container"
        sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- sudo apt remove -y "$PKG"
        FOUND=1
    fi

    if distrobox enter "$FEDORA_BOX" -- rpm -q "$PKG" &>/dev/null; then
        log "Removing via Fedora container"
        sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- sudo dnf remove -y "$PKG"
        FOUND=1
    fi

    if [[ FOUND -eq 0 ]]; then
        log "Package '$PKG' is not installed anywhere."
        exit 1
    fi

    log "Removal Finished."
}

#%%%%%%%%%%%%%%%%%%%%%% Update %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

update_all() {

    log "Updating Arch packages..."
    sudo pacman -Syu

    if command_exists yay; then
        log "Updating AUR (yay) packages..."
        sudo -u "$SUDO_USER" yay -Syu
    fi

    log "Updating Debian Container..."
    sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- sudo apt update && sudo apt upgrade -y

    log "Updating Fedora Container..."
    sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- sudo dnf upgrade -y

    log "Update complete."
}

#%%%%%%%%%%%%%%%%%%%%%%%%%% CLI %%%%%%%%%%%%%%%%%%%%%%%%%%%%

case "$1" in

    install)
        shift  # remove "install"

        SOURCE=""
        PACKAGES=()

        for arg in "$@"; do
            if [[ "$arg" == --source=* ]]; then
                SOURCE="${arg#--source=}"
            else
                PACKAGES+=("$arg")
            fi
        done
    
        if [[ ${#PACKAGES[@]} -eq 0 ]]; then
            echo "No packages specified."
            exit 1
        fi
    
        for pkg in "${PACKAGES[@]}"; do
            install_pkg "$pkg" "$SOURCE"
        done
        ;;

    remove)
        remove_pkg "$2"
        ;;

    search)
        search_pkg "$2"
        ;;

    update)
        update_all
        ;;

    *)
        echo "Magnet Package Management Wrapper"
        echo ""
        echo "Usage:"
        echo " magnet install <pkg>"
        echo " magnet remove <pkg>"
        echo " magnet search <pkg>"
        echo " magnet update"
        ;;
esac
