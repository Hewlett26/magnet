#!/bin/bash
set -u

#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
#  Magnet Package Management Wrapper  #
#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

LOGFILE="/var/log/magnet.log"

log() {
	echo "[MAGNET] $1"
	echo "[MAGNET] $1" >> "$LOGFILE" 2>/dev/null || true
}

#%%%%%%%%%%%%%%%%%%%% Safety %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

#%%%%%%%%%%%%%%%%%%%%% Config %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

DEBIAN_BOX="magnet-debian"
FEDORA_BOX="magnet-fedora"

#%%%%%%%%%%%%%%%%%%%%% Helpers %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

command_exists() {
	command -v "$1" >/dev/null 2>&1
}

pacman_has() {
	pacman -Si "$1" &>/dev/null
}

aur_has() {
	sudo -u "$SUDO_USER" yay -Si "$1" &>/dev/null
}

apt_has() {
	sudo -u "$SUDO_USER" distrobox enter "magnet-debian" -- apt-cache show "$1" &>/dev/null
}

dnf_has() {
	sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- dnf info "$1" &>/dev/null
}

#%%%%%%%%%%%%%%%%%%%%%% Install %%%%%%%%%%%%%%%%%%%%%%%%%%%%

install_pkg() {
    PKG="$1"
    FORCE_SRC="$2"

    log "Searching for $PKG..."

    if [[ -n "$FORCE_SRC" ]]; then
        SRC="$FORCE_SRC"
    else
        SRC=$(select_source "$PKG") || exit 1
    fi

    case "$SRC" in

        pacman)
            log "Installing via pacman..."
            sudo pacman -S --needed "$PKG"
            ;;

        aur)
            log "Installing via AUR..."
            sudo -u "$SUDO_USER" yay -S "$PKG"
            ;;

        debian)
            log "Installing via Debian container..."
            sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- sudo apt install -y "$PKG"
            ;;

        fedora)
            log "Installing via Fedora container..."
            sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- sudo dnf install -y "$PKG"
            ;;

        *)
            log "Invalid source: $SRC"
            exit 1
            ;;

    esac
}


#%%%%%%%%%%%%%%%%%%%%%% Remove %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

remove_pkg() {
	PKG="$1"
	FOUND=0
	
	log "Searching for $PKG..."
	
	if pacman -Qi "$PKG" &>/dev/null; then
		log "Removing via pacman..."
		sudo pacman -Rns "$PKG"
		FOUND=1
	fi
	
	if command_exists yay && yay -Qi "$PKG" &>/dev/null; then
		log "Removing via AUR..."
		sudo -u "$SUDO_USER" yay -Rns "$PKG"
		FOUND=1
	fi
	
	if distrobox enter "$DEBIAN_BOX" -- dpkg -s "$PKG" &>/dev/null; then
		log "Removing via Debian container"
		sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- sudo apt remove -y "$PKG"
		FOUND=1
	fi
	
	if distrobox enter "$FEDORA_BOX" -- rpm -q "$PKG" &>/dev/null; then
		log "Removing via Fedora container"
		sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- sudo dnf remove -y "$PKG"
		FOUND=1
	fi
	
	if [[ FOUND -eq 0 ]]; then
		log "Package '$PKG' is not installed anywhere."
		exit 1
	fi
	
	log "Removal Finished."
}

#%%%%%%%%%%%%%%%%%%%%%% Update %%%%%%%%%%%%%%%%%%%%%%%%%%%%%

update_all() {

	log "Updating Arch packages..."
	sudo pacman -Syu
	
	if command_exists yay; then
		log "Updating AUR (yay) packages..."
		sudo -u "$SUDO_USER" yay -Syu
	fi
	
	log "Updating Debian Container..."
	sudo -u "$SUDO_USER" distrobox enter "$DEBIAN_BOX" -- sudo apt update && sudo apt upgrade -y
	
	log "Updating Fedora Container..."
	sudo -u "$SUDO_USER" distrobox enter "$FEDORA_BOX" -- sudo dnf upgrade -y
	
	log "Update complete."
}

#%%%%%%%%%%%%%%%%%%%%%%% Search %%%%%%%%%%%%%%%%%%%%%%%%%%%%

search_pkg() {
    PKG="$1"
    FOUND=0

    log "Searching for $PKG..."

    if pacman_has "$PKG"; then
        echo "Found in: pacman (host)"
        FOUND=1
    fi

    if command_exists yay && aur_has "$PKG"; then
        echo "Found in: aur"
        FOUND=1
    fi

    if apt_has "$PKG"; then
        echo "Found in: debian container ($DEBIAN_BOX)"
        FOUND=1
    fi

    if dnf_has "$PKG"; then
        echo "Found in: fedora container ($FEDORA_BOX)"
        FOUND=1
    fi

    if [[ $FOUND -eq 0 ]]; then
        log "Package not found anywhere."
        return 1
    fi
}

#%%%%%%%%%%%%%% Placeholder of Self Update %%%%%%%%%%%%%%%%%





#%%%%%%%%%%%%%%%%%%%%%%%%%% CLI %%%%%%%%%%%%%%%%%%%%%%%%%%%%

case "$1" in

	search)
    	search_pkg "$2"
    	;;


	install)
    	if [[ "$3" == "--from" ]]; then
        	install_pkg "$2" "$4"
    	else
        	install_pkg "$2"
   		fi
    	;;

	
	remove)
		remove_pkg "$2"
		;;
	
	update)
		update_all
		;;
	
	*)
		echo "Magnet Package Management Wrapper"
		echo ""
		echo "Usage:"
		echo " magnet install <pkg>"
		echo " magnet remove <pkg>"
		echo " magnet update"
		;;
esac
